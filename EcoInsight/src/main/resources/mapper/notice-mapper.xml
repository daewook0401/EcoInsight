<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.semi.ecoinsight.notice.model.dao.NoticeMapper">
    <sql id="noticeSelect">
        SELECT
            BOARD_NO boardNo,
            CATEGORY_ID categoryId,
            MEMBER_NO memberNo,
            BOARD_TITLE boardTitle,
            BOARD_CONTENT boardContent,
            CREATED_DATE createdDate,
            MODIFIED_DATE modifiedDate,
            VIEW_COUNT viewCount,
            IS_DELETED isDeleted,
            MEMBER_ID memberId,
            MEMBER_NAME memberName
        FROM
            TB_NOTICE   
        JOIN
            TB_MEMBER USING(MEMBER_NO)
    </sql>


    <insert id="insertNotice" parameterType="com.semi.ecoinsight.board.model.vo.Board"> 
        INSERT INTO
            TB_NOTICE( 
                CATEGORY_ID, 
                MEMBER_NO, 
                BOARD_TITLE, 
                BOARD_CONTENT 
            ) 
        VALUES( 
            #{categoryId},
            #{memberNo}, 
            #{boardTitle}, 
            #{boardContent} 
        ) 
    </insert>

    <select id="getNoticeNo" parameterType="long" resultType="long"> 
        SELECT 
            BOARD_NO AS boardNo 
        FROM
            TB_NOTICE 
        WHERE 
            MEMBER_NO = #{memberNo} 
        ORDER BY 
            CREATED_DATE DESC FETCH FIRST 1 ROWS ONLY 
    </select>

    <!-- NoticeCount -->
    <!-- 공지사항 전체 크기조회 -->
    <select id="getTotalNoticeCount">
        SELECT
            COUNT(*)
        FROM
            TB_NOTICE
        WHERE
            IS_DELETED = 'N'
    </select>
    <!-- 공지사항 카테고리별 크기조회 -->
    <select id="getNoticeCountByCategoryId">
        SELECT
            COUNT(*)
        FROM
            TB_NOTICE
        WHERE
            IS_DELETED = 'N'
        AND
            CATEGORY_ID = #{category}
    </select>
    <!-- 공지사항 검색어 결과 기준 갯수 조회 -->
    <select id="getNoticeCountBySearch">
        SELECT
            COUNT(*)
        FROM
            TB_NOTICE
        JOIN
            TB_MEMBER USING(MEMBER_NO)
        WHERE
        <choose>
            <when test="searchType == 'name'">
                MEMBER_NAME LIKE '%'||#{search}||'%'
            </when>
            <when test="searchType == 'title'">
                BOARD_TITLE LIKE '%'||#{search}||'%'
            </when>
            <otherwise>
                MEMBER_NAME LIKE '%'||#{search}||'%'
                OR
                BOARD_TITLE LIKE '%'||#{search}||'%'
            </otherwise>
        </choose>
    </select>

    <!-- 공지사항 목록 조회 -->
    <select id="selectNoticeList"
        resultType="com.semi.ecoinsight.board.model.dto.BoardDTO">
        <include refid="noticeSelect" />
        WHERE
            IS_DELETED = 'N'
        ORDER BY
            CREATED_DATE DESC
        OFFSET #{startIndex} ROWS FETCH NEXT #{size} ROWS ONLY
    </select>
    <!-- 공지사항 카테고리별 목록 조회 -->
    <select id="selectNoticeListByCategory"
        resultType="com.semi.ecoinsight.board.model.dto.BoardDTO">
        <include refid="noticeSelect" />
        WHERE
            IS_DELETED = 'N'
        AND
            CATEGORY_ID = #{category}
        ORDER BY
            CREATED_DATE DESC
        OFFSET #{startIndex} ROWS FETCH NEXT #{size} ROWS ONLY
    </select>


    <!-- 관리자용 조회 -->
    <select id="selectNoticeListForAdmin"
        resultType="com.semi.ecoinsight.board.model.dto.BoardDTO">
        <include refid="noticeSelect" />
        ORDER BY
            CREATED_DATE DESC
        OFFSET #{startIndex} ROWS FETCH NEXT #{size} ROWS ONLY
    </select>
    <!-- 목록 조회 검색(관리자용) -->
    <select id="selectSearchedNoticeListForAdmin">
        <include refid="noticeSelect" /> 
        WHERE
        <choose>
            <when test="searchType == 'name'"> 
                MEMBER_NAME LIKE '%'||#{search}||'%' 
            </when>
            <when test="searchType == 'title'"> 
                BOARD_TITLE LIKE '%'||#{search}||'%' 
            </when>
            <otherwise> 
                    MEMBER_NAME LIKE '%'||#{search}||'%' 
                OR    
                    BOARD_TITLE LIKE '%'||#{search}||'%' 
            </otherwise>
        </choose>
        ORDER BY
        CREATED_DATE DESC
    </select>

    <!-- 공지사항 세부페이지 조회 -->
    <select id="selectNoticeDetail">
        <include refid="noticeSelect" />
        WHERE
            BOARD_NO = #{boardNo}
        AND
            IS_DELETED = 'N'
    </select>

    <!-- 조회수 증가 -->
    <update id="increaseNoticeViewCount"
        parameterType="long"> 
        UPDATE 
            TB_NOTICE 
        SET 
            VIEW_COUNT = VIEW_COUNT+1 
        WHERE
            BOARD_NO = #{boardNo} 
    </update>




</mapper>